<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Display Test - Chat Modal Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
        }
        
        h1 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .demo-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .demo-section h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        .credit-balance-display {
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .credit-label {
            font-weight: bold;
            color: #e0e0e0;
            min-width: 120px;
        }
        
        .credit-amount {
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .credit-amount.guest-credits {
            background: #FF9800;
        }
        
        .credit-amount.low-credits {
            background: #f44336;
            animation: pulse 2s infinite;
        }
        
        .credit-amount.error {
            background: #9C27B0;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .refresh-credits-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .refresh-credits-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
        
        .demo-buttons {
            margin: 15px 0;
        }
        
        .demo-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }
        
        .demo-btn:hover {
            background: #45a049;
        }
        
        .demo-btn.danger {
            background: #f44336;
        }
        
        .demo-btn.danger:hover {
            background: #da190b;
        }
        
        .debug-info {
            background: #1a1a1a;
            border: 1px solid #666;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-warning { background: #FF9800; }
        .status-info { background: #2196F3; }
        
        .simulated-modal {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }
        
        .modal-title {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .modal-btn:hover {
            background: #0056b3;
        }
        
        .modal-btn.danger {
            background: #dc3545;
        }
        
        .modal-btn.danger:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéØ Credit Display Test - Chat Modal Simulation</h1>
        <p>This page demonstrates the credit display functionality for the chat modal header and helps debug the "stuck at zero" issue.</p>
        
        <div class="demo-section">
            <h3>üí∞ Credit Balance Display (Chat Modal Header)</h3>
            <div class="credit-balance-display">
                <span class="credit-label">Token Credits:</span>
                <span id="token-credits" class="credit-amount">Loading...</span>
                <span class="credit-label">Image Credits:</span>
                <span id="image-credits" class="credit-amount">Loading...</span>
                <button id="refresh-credits" class="refresh-credits-btn" title="Refresh Credits">üîÑ</button>
            </div>
            
            <div class="demo-buttons">
                <button class="demo-btn" onclick="simulateLowCredits()">Simulate Low Credits</button>
                <button class="demo-btn" onclick="simulateNormalCredits()">Simulate Normal Credits</button>
                <button class="demo-btn" onclick="simulateGuestCredits()">Simulate Guest Credits</button>
                <button class="demo-btn" onclick="simulateRefresh()">Test Refresh Button</button>
                <button class="demo-btn" onclick="testCreditLoading()">Test Credit Loading</button>
                <button class="demo-btn danger" onclick="clearCredits()">Clear Credits</button>
            </div>
        </div>
        
        <div class="demo-section">
            <h3>üîç Debug Information</h3>
            <div class="debug-info" id="debug-output">
                <div><span class="status-indicator status-info"></span>Debug output will appear here...</div>
            </div>
            
            <div class="demo-buttons">
                <button class="demo-btn" onclick="checkAJAXObject()">Check AJAX Object</button>
                <button class="demo-btn" onclick="checkCreditElements()">Check Credit Elements</button>
                <button class="demo-btn" onclick="simulateAJAXResponse()">Simulate AJAX Response</button>
                <button class="demo-btn" onclick="clearDebug()">Clear Debug</button>
            </div>
        </div>
        
        <div class="demo-section">
            <h3>üé≠ Simulated Chat Modal</h3>
            <div class="simulated-modal">
                <div class="modal-header">
                    <div class="modal-title">Character Chat</div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="openModal()">Open Modal</button>
                        <button class="modal-btn danger" onclick="closeModal()">Close Modal</button>
                    </div>
                </div>
                
                <div class="credit-balance-display">
                    <span class="credit-label">Token Credits:</span>
                    <span id="modal-token-credits" class="credit-amount">0</span>
                    <span class="credit-label">Image Credits:</span>
                    <span id="modal-image-credits" class="credit-amount">0</span>
                    <button id="modal-refresh-credits" class="refresh-credits-btn" title="Refresh Credits">üîÑ</button>
                </div>
                
                <div class="demo-buttons">
                    <button class="demo-btn" onclick="loadModalCredits()">Load Modal Credits</button>
                    <button class="demo-btn" onclick="testModalTiming()">Test Modal Timing</button>
                </div>
            </div>
        </div>
        
        <div class="demo-section">
            <h3>üìã Test Scenarios</h3>
            <p>Use these scenarios to test different credit display states:</p>
            <ul>
                <li><strong>Normal Credits:</strong> Shows regular credit balances with green styling</li>
                <li><strong>Low Credits:</strong> Shows low credits with red pulsing animation</li>
                <li><strong>Guest Credits:</strong> Shows guest limits with orange styling</li>
                <li><strong>Error State:</strong> Shows error state with purple styling</li>
                <li><strong>Loading State:</strong> Shows loading state while fetching credits</li>
            </ul>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Simulate the pmv_ajax_object that would normally be localized by WordPress
        window.pmv_ajax_object = {
            ajax_url: 'https://example.com/wp-admin/admin-ajax.php',
            nonce: 'test_nonce_123',
            user_id: 1,
            is_logged_in: true,
            guest_limits: {
                daily_images: 50,
                monthly_tokens: 10000
            },
            chat_button_text: 'Chat'
        };

        // Simulate the PMV_ChatCore object
        window.PMV_ChatCore = {
            loadCreditBalances: function() {
                console.log('PMV: Loading credit balances...');
                console.log('PMV: AJAX object:', typeof pmv_ajax_object !== 'undefined' ? pmv_ajax_object : 'undefined');
                
                if (typeof pmv_ajax_object === 'undefined') {
                    console.error('PMV: pmv_ajax_object is not defined!');
                    jQuery('#token-credits').text('No AJAX');
                    jQuery('#image-credits').text('No AJAX');
                    return;
                }
                
                if (!pmv_ajax_object.ajax_url) {
                    console.error('PMV: AJAX URL is missing!');
                    jQuery('#token-credits').text('No URL');
                    jQuery('#image-credits').text('No URL');
                    return;
                }
                
                // Enhanced user authentication check with detailed logging
                console.log('PMV: User ID check:', {
                    user_id: pmv_ajax_object.user_id,
                    user_id_type: typeof pmv_ajax_object.user_id,
                    is_logged_in: pmv_ajax_object.is_logged_in,
                    is_logged_in_type: typeof pmv_ajax_object.is_logged_in,
                    guest_limits: pmv_ajax_object.guest_limits
                });
                
                // Check if user is logged in - use both user_id and is_logged_in flag
                if ((pmv_ajax_object.user_id === 0 || !pmv_ajax_object.user_id) && !pmv_ajax_object.is_logged_in) {
                    console.log('PMV: User not logged in, showing guest limits');
                    
                    // Show guest limits if available
                    if (pmv_ajax_object.guest_limits) {
                        jQuery('#token-credits').text(pmv_ajax_object.guest_limits.monthly_tokens.toLocaleString());
                        jQuery('#image-credits').text(pmv_ajax_object.guest_limits.daily_images.toLocaleString());
                        
                        // Add guest styling
                        jQuery('#token-credits').addClass('guest-credits');
                        jQuery('#image-credits').addClass('guest-credits');
                    } else {
                        jQuery('#token-credits').text('Guest');
                        jQuery('#image-credits').text('Guest');
                    }
                    return;
                }
                
                console.log('PMV: User appears to be logged in, attempting AJAX credit fetch...');
                
                // Check if credit elements exist
                const tokenCreditsElement = jQuery('#token-credits');
                const imageCreditsElement = jQuery('#image-credits');
                
                if (!tokenCreditsElement.length || !imageCreditsElement.length) {
                    console.error('PMV: Credit elements not found!', {
                        tokenCredits: tokenCreditsElement.length,
                        imageCredits: imageCreditsElement.length
                    });
                    
                    // Retry after a short delay in case of timing issues
                    setTimeout(() => {
                        console.log('PMV: Retrying credit loading after delay...');
                        this.loadCreditBalances();
                    }, 200);
                    return;
                }
                
                console.log('PMV: Credit elements found, proceeding with AJAX request...');
                
                // Simulate AJAX response for testing
                setTimeout(() => {
                    const mockResponse = {
                        success: true,
                        data: {
                            credits: {
                                text_credits: 1250,
                                image_credits: 45
                            }
                        }
                    };
                    
                    console.log('PMV: Credit response:', mockResponse);
                    if (mockResponse.success && mockResponse.data.credits) {
                        const credits = mockResponse.data.credits;
                        console.log('PMV: Updating credit display with:', credits);
                        jQuery('#token-credits').text(credits.text_credits.toLocaleString());
                        jQuery('#image-credits').text(credits.image_credits.toLocaleString());
                        
                        // Remove any existing classes
                        jQuery('#token-credits').removeClass('guest-credits low-credits');
                        jQuery('#image-credits').removeClass('guest-credits low-credits');
                        
                        // Add visual indicators for low credits
                        if (credits.text_credits < 1000) {
                            jQuery('#token-credits').addClass('low-credits');
                        }
                        
                        if (credits.image_credits < 10) {
                            jQuery('#image-credits').addClass('low-credits');
                        }
                    }
                }, 500);
            }
        };

        // Debug functions
        function addDebugMessage(message, type = 'info') {
            const debugOutput = document.getElementById('debug-output');
            const statusClass = `status-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<span class="status-indicator ${statusClass}"></span>[${timestamp}] ${message}`;
            debugOutput.appendChild(messageDiv);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        function checkAJAXObject() {
            addDebugMessage('Checking AJAX object...', 'info');
            addDebugMessage(`AJAX Object exists: ${typeof pmv_ajax_object !== 'undefined'}`, 'info');
            if (typeof pmv_ajax_object !== 'undefined') {
                addDebugMessage(`User ID: ${pmv_ajax_object.user_id}`, 'info');
                addDebugMessage(`Is Logged In: ${pmv_ajax_object.is_logged_in}`, 'info');
                addDebugMessage(`AJAX URL: ${pmv_ajax_object.ajax_url}`, 'info');
                addDebugMessage(`Guest Limits: ${JSON.stringify(pmv_ajax_object.guest_limits)}`, 'info');
            }
        }

        function checkCreditElements() {
            addDebugMessage('Checking credit elements...', 'info');
            const tokenCredits = jQuery('#token-credits');
            const imageCredits = jQuery('#image-credits');
            addDebugMessage(`Token Credits Element: ${tokenCredits.length ? 'Found' : 'Not Found'}`, tokenCredits.length ? 'success' : 'error');
            addDebugMessage(`Image Credits Element: ${imageCredits.length ? 'Found' : 'Not Found'}`, imageCredits.length ? 'success' : 'error');
            if (tokenCredits.length) {
                addDebugMessage(`Token Credits Text: "${tokenCredits.text()}"`, 'info');
            }
            if (imageCredits.length) {
                addDebugMessage(`Image Credits Text: "${imageCredits.text()}"`, 'info');
            }
        }

        function simulateAJAXResponse() {
            addDebugMessage('Simulating AJAX response...', 'info');
            // Simulate different responses
            const responses = [
                { text_credits: 1250, image_credits: 45 },
                { text_credits: 500, image_credits: 5 },
                { text_credits: 0, image_credits: 0 }
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addDebugMessage(`Simulated response: ${JSON.stringify(randomResponse)}`, 'success');
            
            jQuery('#token-credits').text(randomResponse.text_credits.toLocaleString());
            jQuery('#image-credits').text(randomResponse.image_credits.toLocaleString());
            
            // Remove existing classes
            jQuery('#token-credits, #image-credits').removeClass('guest-credits low-credits');
            
            // Add appropriate classes
            if (randomResponse.text_credits < 1000) {
                jQuery('#token-credits').addClass('low-credits');
            }
            if (randomResponse.image_credits < 10) {
                jQuery('#image-credits').addClass('low-credits');
            }
        }

        function clearDebug() {
            document.getElementById('debug-output').innerHTML = '<div><span class="status-indicator status-info"></span>Debug output cleared...</div>';
        }

        // Demo functions
        function simulateLowCredits() {
            jQuery('#token-credits').text('500').removeClass('guest-credits').addClass('low-credits');
            jQuery('#image-credits').text('5').removeClass('guest-credits').addClass('low-credits');
            addDebugMessage('Simulated low credits state', 'warning');
        }

        function simulateNormalCredits() {
            jQuery('#token-credits').text('1,250').removeClass('guest-credits low-credits');
            jQuery('#image-credits').text('45').removeClass('guest-credits low-credits');
            addDebugMessage('Simulated normal credits state', 'success');
        }

        function simulateGuestCredits() {
            jQuery('#token-credits').text('10,000').removeClass('low-credits').addClass('guest-credits');
            jQuery('#image-credits').text('50').removeClass('low-credits').addClass('guest-credits');
            addDebugMessage('Simulated guest credits state', 'warning');
        }

        function simulateRefresh() {
            const refreshBtn = jQuery('#refresh-credits');
            refreshBtn.css('transform', 'rotate(360deg)');
            setTimeout(() => {
                refreshBtn.css('transform', '');
                addDebugMessage('Refresh button animation completed', 'success');
            }, 500);
        }

        function testCreditLoading() {
            addDebugMessage('Testing credit loading function...', 'info');
            if (window.PMV_ChatCore && window.PMV_ChatCore.loadCreditBalances) {
                window.PMV_ChatCore.loadCreditBalances();
                addDebugMessage('Credit loading function called successfully', 'success');
            } else {
                addDebugMessage('Credit loading function not available', 'error');
            }
        }

        function clearCredits() {
            jQuery('#token-credits, #image-credits').text('0').removeClass('guest-credits low-credits');
            addDebugMessage('Credits cleared', 'info');
        }

        // Modal simulation functions
        function openModal() {
            addDebugMessage('Opening simulated modal...', 'info');
            document.querySelector('.simulated-modal').style.borderColor = '#4CAF50';
            addDebugMessage('Modal opened successfully', 'success');
        }

        function closeModal() {
            addDebugMessage('Closing simulated modal...', 'info');
            document.querySelector('.simulated-modal').style.borderColor = '#444';
            addDebugMessage('Modal closed successfully', 'info');
        }

        function loadModalCredits() {
            addDebugMessage('Loading credits in modal...', 'info');
            // Simulate loading credits in the modal
            setTimeout(() => {
                jQuery('#modal-token-credits').text('1,250');
                jQuery('#modal-image-credits').text('45');
                addDebugMessage('Modal credits loaded successfully', 'success');
            }, 500);
        }

        function testModalTiming() {
            addDebugMessage('Testing modal timing...', 'info');
            // Simulate the timing issue that might occur in the real chat modal
            setTimeout(() => {
                addDebugMessage('Modal timing test completed', 'success');
            }, 100);
        }

        // Initialize
        jQuery(document).ready(function() {
            addDebugMessage('Page loaded, PMV_ChatCore and pmv_ajax_object simulated', 'success');
            
            // Add click handler for refresh button
            jQuery('#refresh-credits').click(function() {
                addDebugMessage('Refresh button clicked', 'info');
                testCreditLoading();
            });
            
            jQuery('#modal-refresh-credits').click(function() {
                addDebugMessage('Modal refresh button clicked', 'info');
                loadModalCredits();
            });
        });
    </script>
</body>
</html>
